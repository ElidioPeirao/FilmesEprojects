<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineCorp - Streaming Corporativo</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Animações e Utilitários Customizados */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        /* Barra de Progresso Animada */
        .progress-bar {
            position: relative;
            overflow: hidden;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg, 
                rgba(255, 255, 255, 0.2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.2) 75%, 
                transparent 75%, 
                transparent
            );
            background-size: 20px 20px;
            animation: moveStripes 1s linear infinite;
        }
        @keyframes moveStripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 20px; }
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 font-sans selection:bg-red-600 selection:text-white min-h-screen flex flex-col">

    <!-- Container Principal da Aplicação -->
    <div id="app" class="flex-grow">
        <div class="h-screen w-full flex items-center justify-center text-slate-500">
            Carregando Sistema CineCorp...
        </div>
    </div>

    <!-- Firebase e Lógica da Aplicação -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, updateDoc, doc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // --- Configuração Global ---
        const firebaseConfig = {
            apiKey: "AIzaSyDB73S-zwyDZUbLZdvueVVPEC67euQ-5HY",
            authDomain: "eprojectsnormas-73e94.firebaseapp.com",
            projectId: "eprojectsnormas-73e94",
            storageBucket: "eprojectsnormas-73e94.firebasestorage.app",
            messagingSenderId: "953429912621",
            appId: "1:953429912621:web:191774477ed076615c9ca4",
            measurementId: "G-1EMB2W7P6E"
        };
        
        const appId = 'cine-corp-production-v1';
        const ADMIN_PASSWORD = "admin123";
        
        // CHAVE DA API DO GEMINI: A chave fornecida pelo usuário foi inserida aqui.
        const apiKey = "AIzaSyBi4vCPvQovoSVsduKlytqoDkscvQ6JGoQ"; 
        
        let db, auth, user;
        const isFirebaseConfigured = true;

        // --- Estado da Aplicação ---
        const state = {
            user: null,
            isAdmin: false,
            // Modais e UI
            showAuthModal: false, 
            authError: '',
            modalConfirm: { show: false, title: '', message: '', onConfirm: null }, 
            toast: { show: false, message: '', type: 'info' },
            
            movies: [],
            view: 'catalog',
            selectedMovie: null,
            searchTerm: '',
            generatingImages: {}, 
            
            // Estado de Edição
            editingId: null, // ID do filme sendo editado (null se for novo)

            form: {
                title: '',
                genre: '',
                rating: '',
                duration: '',
                desc: '',
                url: '',
                thumbnailUrl: '',
                isGenerating: false,
                isSaving: false
            }
        };

        // --- Inicialização do Firebase ---
        async function initFirebase() {
            if (!isFirebaseConfigured) return;
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, (u) => {
                state.user = u;
                if (u) subscribeToMovies();
                renderApp();
            });

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Auth error:", error);
            }
        }

        function subscribeToMovies() {
            if (!db || !state.user) return;
            const moviesRef = collection(db, 'artifacts', appId, 'public', 'data', 'movies');
            const q = query(moviesRef);

            onSnapshot(q, (snapshot) => {
                const loadedMovies = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                // Ordenar por data
                loadedMovies.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                state.movies = loadedMovies;
                renderApp();
            });
        }

        // --- Helpers ---
        function showToast(message, type = 'info') {
            state.toast = { show: true, message, type };
            renderApp();
            setTimeout(() => {
                state.toast.show = false;
                renderApp();
            }, 3000);
        }

        async function fetchGemini(title) {
            // INSTRUÇÃO FORTALECIDA: Exigir que a IA preencha todos os campos.
            const systemPrompt = `Você é um assistente de catálogo de filmes corporativos. Dada a consulta, você DEVE retornar um objeto JSON COMPLETO, preenchendo todos os campos. Invente uma duração e uma descrição detalhada se o filme for desconhecido. Os campos são: genre, rating, duration (formato '1h 30min'), description (em Português), e visualPrompt (em Inglês).`;
            const userPrompt = `Filme: "${title}"`;
            
            // Usando a chave fornecida na URL, necessário para ambientes que não injetam o token automaticamente.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetch(
                    apiUrl,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: userPrompt }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: {
                                responseMimeType: "application/json",
                                responseSchema: {
                                    type: "OBJECT",
                                    properties: {
                                        genre: { type: "STRING" },
                                        rating: { type: "STRING" },
                                        duration: { type: "STRING" },
                                        description: { type: "STRING" },
                                        visualPrompt: { type: "STRING" }
                                    }
                                }
                            }
                        }),
                    }
                );
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error("Erro da API Gemini (Status/Corpo):", response.status, errorText);
                    throw new Error(`API Error: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();
                
                if (!result.candidates || !result.candidates[0] || !result.candidates[0].content) {
                    throw new Error("Formato de resposta inválido da API");
                }

                let text = result.candidates[0].content.parts[0].text;
                
                // Limpeza: Remove blocos de código Markdown se a IA os incluir
                text = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();

                const parsedData = JSON.parse(text);

                return parsedData;

            } catch (e) {
                console.error("Detalhes do erro Gemini:", e);
                throw e;
            }
        }

        function getDriveEmbedLink(url) {
            let id = null;
            const m1 = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (m1) id = m1[1];
            else {
                const m2 = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
                if (m2) id = m2[1];
            }
            return id ? `https://drive.google.com/file/d/${id}/preview` : url;
        }

        // --- Ações ---
        window.actions = {
            setView: (view) => { state.view = view; renderApp(); },
            
            // Auth Modal
            openAuthModal: () => {
                if (state.isAdmin) {
                    state.isAdmin = false;
                    state.view = 'catalog';
                    showToast("Modo Usuário Ativado");
                } else {
                    state.showAuthModal = true;
                    state.authError = '';
                }
                renderApp();
                setTimeout(() => document.getElementById('pass-input')?.focus(), 50);
            },
            closeAuthModal: () => { state.showAuthModal = false; renderApp(); },
            attemptLogin: (pwd) => {
                if (pwd === ADMIN_PASSWORD) {
                    state.isAdmin = true;
                    state.showAuthModal = false;
                    state.view = 'admin';
                    showToast("Modo Admin Ativado", "success");
                } else {
                    state.authError = 'Senha incorreta';
                    setTimeout(() => { state.authError = ''; renderApp(); }, 2000);
                }
                renderApp();
            },

            // Confirm Modal
            closeConfirm: () => {
                state.modalConfirm = { show: false, title: '', message: '', onConfirm: null };
                renderApp();
            },
            confirmAction: async () => {
                if (state.modalConfirm.onConfirm) {
                    await state.modalConfirm.onConfirm();
                }
            },
            triggerConfirm: (title, message, callback) => {
                state.modalConfirm = {
                    show: true,
                    title,
                    message,
                    onConfirm: async () => {
                        state.modalConfirm.show = false;
                        renderApp();
                        await callback();
                    }
                };
                renderApp();
            },

            updateForm: (f, v) => state.form[f] = v,
            updateSearch: (v) => { state.searchTerm = v; renderApp(); },
            openPlayer: (id) => { state.selectedMovie = state.movies.find(m=>m.id===id); state.view='player'; renderApp(); },

            // --- Ações de Edição ---
            editMovie: (id) => {
                const m = state.movies.find(x => x.id === id);
                if (!m) return;
                
                // Popula o formulário com os dados do filme
                state.form = {
                    title: m.title,
                    genre: m.genre,
                    rating: m.rating,
                    duration: m.duration,
                    desc: m.description,
                    url: m.videoUrl, // URL original para edição
                    thumbnailUrl: m.thumbnailUrl,
                    isGenerating: false,
                    isSaving: false
                };
                state.editingId = id; // Marca que estamos editando
                
                // Rola para o topo (formulário)
                document.querySelector('.admin-form-container')?.scrollIntoView({ behavior: 'smooth' });
                renderApp();
            },
            
            cancelEdit: () => {
                // Limpa o form e o ID de edição
                state.form = { title:'', genre:'', rating:'', duration:'', desc:'', url:'', thumbnailUrl:'', isGenerating:false, isSaving:false };
                state.editingId = null;
                renderApp();
            },

            generateAI: async () => {
                if (!state.form.title) return showToast("Digite um título", "error");
                state.form.isGenerating = true;
                renderApp();

                try {
                    const data = await fetchGemini(state.form.title);
                    // Garante que campos críticos tenham um fallback mesmo que o JSON esteja incompleto
                    state.form.genre = data.genre || "Geral";
                    state.form.rating = data.rating || "Livre";
                    state.form.duration = data.duration || "1h 0min"; // Fallback mais útil
                    state.form.desc = data.description || "Descrição não gerada pela IA. Por favor, adicione manualmente.";
                    
                    const prompt = encodeURIComponent(data.visualPrompt || `Movie poster ${state.form.title}`);
                    state.form.thumbnailUrl = `https://image.pollinations.ai/prompt/${prompt}?width=800&height=450&nologo=true&seed=${Math.random()}`;
                } catch(e) {
                    console.error(e);
                    showToast("Erro na IA: Verifique o console", "error");
                } finally {
                    state.form.isGenerating = false;
                    renderApp();
                }
            },

            regenerateImage: (id) => {
                const m = state.movies.find(x => x.id === id);
                if(!m) return;

                window.actions.triggerConfirm(
                    "Regenerar Capa",
                    `Deseja criar uma nova imagem para "${m.title}"?`,
                    async () => {
                        state.generatingImages = { ...state.generatingImages, [id]: true };
                        renderApp(); 

                        try {
                            const prompt = encodeURIComponent(`Movie poster for ${m.title}, ${m.genre}, cinematic, 8k`);
                            const newUrl = `https://image.pollinations.ai/prompt/${prompt}?width=800&height=450&nologo=true&seed=${Math.floor(Math.random()*1000)}`;
                            await new Promise(r => setTimeout(r, 1000)); 

                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'movies', id), {
                                thumbnailUrl: newUrl
                            });
                            showToast("Imagem atualizada!", "success");
                        } catch(e) {
                            showToast("Erro ao atualizar", "error");
                            console.error(e);
                        } finally {
                            state.generatingImages = { ...state.generatingImages, [id]: false };
                            renderApp();
                        }
                    }
                );
            },

            saveMovie: async () => {
                if (!state.form.title || !state.form.url) return showToast("Título e Link obrigatórios", "error");
                state.form.isSaving = true;
                renderApp();

                try {
                    const embedUrl = getDriveEmbedLink(state.form.url);
                    const thumb = state.form.thumbnailUrl || `https://source.unsplash.com/800x450/?cinema`;
                    
                    const movieData = {
                        title: state.form.title,
                        genre: state.form.genre || 'Geral',
                        rating: state.form.rating || 'Livre',
                        duration: state.form.duration || '--',
                        description: state.form.desc || '',
                        videoUrl: state.form.url,
                        embedUrl,
                        thumbnailUrl: thumb,
                    };

                    if (state.editingId) {
                        // MODO EDIÇÃO: Atualiza o doc existente
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'movies', state.editingId), movieData);
                        showToast("Filme atualizado!", "success");
                    } else {
                        // MODO CRIAÇÃO: Cria novo doc com timestamp
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'movies'), {
                            ...movieData,
                            createdAt: serverTimestamp()
                        });
                        showToast("Filme salvo!", "success");
                    }
                    
                    // Limpa tudo após salvar
                    state.form = { title:'', genre:'', rating:'', duration:'', desc:'', url:'', thumbnailUrl:'', isGenerating:false, isSaving:false };
                    state.editingId = null;
                    
                } catch(e) {
                    showToast("Erro ao salvar", "error");
                    console.error(e);
                } finally {
                    state.form.isSaving = false;
                    renderApp();
                }
            },

            deleteMovie: (id) => {
                window.actions.triggerConfirm(
                    "Excluir Filme",
                    "Tem certeza que deseja remover este filme do catálogo?",
                    async () => {
                        try {
                            // Se estiver editando o filme que será deletado, cancela a edição
                            if (state.editingId === id) {
                                state.editingId = null;
                                state.form = { title:'', genre:'', rating:'', duration:'', desc:'', url:'', thumbnailUrl:'', isGenerating:false, isSaving:false };
                            }
                            await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'movies', id));
                            showToast("Filme removido", "success");
                        } catch(e) {
                            showToast("Erro ao excluir", "error");
                        }
                    }
                );
            }
        };

        // --- Renderização ---

        function renderToast() {
            if (!state.toast.show) return '';
            const colors = state.toast.type === 'error' ? 'bg-red-600' : (state.toast.type === 'success' ? 'bg-green-600' : 'bg-blue-600');
            return `
                <div class="fixed top-24 right-6 z-[70] animate-fade-in ${colors} text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3">
                    <i data-lucide="${state.toast.type === 'error' ? 'alert-circle' : 'check-circle'}" width="20"></i>
                    <span class="font-medium">${state.toast.message}</span>
                </div>
            `;
        }

        function renderConfirmModal() {
            if (!state.modalConfirm.show) return '';
            return `
                <div class="fixed inset-0 z-[80] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-2xl max-w-sm w-full">
                        <h3 class="text-xl font-bold text-white mb-2">${state.modalConfirm.title}</h3>
                        <p class="text-slate-400 mb-6">${state.modalConfirm.message}</p>
                        <div class="flex justify-end gap-3">
                            <button onclick="actions.closeConfirm()" class="px-4 py-2 text-slate-400 hover:text-white transition-colors">Cancelar</button>
                            <button onclick="actions.confirmAction()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold transition-colors">Confirmar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAuthModal() {
            if (!state.showAuthModal) return '';
            return `
                <div class="fixed inset-0 z-[60] flex items-center justify-center bg-black/80 backdrop-blur-sm animate-fade-in">
                    <div class="bg-slate-800 p-8 rounded-xl border border-slate-700 shadow-2xl max-w-sm w-full relative">
                        <button onclick="actions.closeAuthModal()" class="absolute top-4 right-4 text-slate-500 hover:text-white"><i data-lucide="x" width="20"></i></button>
                        <div class="text-center mb-6">
                            <div class="bg-red-600 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3"><i data-lucide="lock" class="text-white" width="20"></i></div>
                            <h3 class="text-xl font-bold text-white">Acesso Restrito</h3>
                            <p class="text-slate-400 text-sm mt-1">Senha: alguma ai</p>
                        </div>
                        <input id="pass-input" type="password" placeholder="Senha" class="w-full bg-slate-900 border ${state.authError ? 'border-red-500' : 'border-slate-700'} text-white rounded-lg px-4 py-3 mb-2 focus:border-red-600 outline-none" onkeydown="if(event.key === 'Enter') actions.attemptLogin(this.value)" />
                        ${state.authError ? `<p class="text-red-500 text-xs mb-3 text-center">${state.authError}</p>` : ''}
                        <button onclick="actions.attemptLogin(document.getElementById('pass-input').value)" class="w-full bg-white text-black font-bold py-3 rounded-lg hover:bg-slate-200 mt-2">Entrar</button>
                    </div>
                </div>
            `;
        }

        function renderNavbar() {
            return `
                <nav class="fixed top-0 w-full z-50 bg-slate-900/95 backdrop-blur border-b border-slate-800 px-6 py-4 flex items-center justify-between">
                    <div class="flex items-center gap-2 cursor-pointer" onclick="actions.setView('catalog')">
                        <i data-lucide="monitor-play" class="text-red-600 w-8 h-8"></i>
                        <h1 class="text-2xl font-bold tracking-tighter text-white">CINE<span class="text-red-600">CORP</span></h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="actions.openAuthModal()" class="flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-bold transition-all ${state.isAdmin ? 'bg-red-600 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}">
                            <i data-lucide="${state.isAdmin ? 'shield-check' : 'user'}" width="14"></i>
                            ${state.isAdmin ? 'SAIR DO ADMIN' : 'MODO USUÁRIO'}
                        </button>
                        ${state.isAdmin ? `<button onclick="actions.setView('admin')" class="bg-white text-black hover:bg-slate-200 px-4 py-2 rounded font-semibold text-sm transition-colors flex items-center gap-2"><i data-lucide="plus" width="18"></i> Adicionar Filme</button>` : ''}
                    </div>
                </nav>
            `;
        }

        function renderCatalog() {
            const filtered = state.movies.filter(m => 
                m.title.toLowerCase().includes(state.searchTerm.toLowerCase()) ||
                m.genre.toLowerCase().includes(state.searchTerm.toLowerCase())
            );

            return `
                <div class="animate-fade-in pt-24 pb-12 px-6 max-w-7xl mx-auto">
                    <div class="mb-10 flex flex-col md:flex-row justify-between items-end gap-4 border-b border-slate-800 pb-6">
                        <div>
                            <h2 class="text-3xl font-bold mb-2 text-white">Catálogo</h2>
                            <p class="text-slate-400">Treinamentos e filmes corporativos.</p>
                        </div>
                        <div class="relative w-full md:w-96">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 w-5 h-5"></i>
                            <input type="text" placeholder="Buscar..." class="w-full bg-slate-800 border border-slate-700 text-white focus:border-red-600 rounded-full py-2.5 pl-10 pr-4 outline-none transition-all text-sm" value="${state.searchTerm}" oninput="actions.updateSearch(this.value)" />
                        </div>
                    </div>

                    ${filtered.length === 0 ? `
                        <div class="text-center py-20 text-slate-500">
                            <i data-lucide="film" class="w-16 h-16 mx-auto mb-4 opacity-20"></i>
                            <p>Nada encontrado.</p>
                        </div>
                    ` : `
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            ${filtered.map(m => `
                                <div onclick="actions.openPlayer('${m.id}')" class="group bg-slate-800 rounded-lg overflow-hidden hover:scale-[1.02] transition-transform duration-300 cursor-pointer shadow-lg border border-slate-700 hover:border-red-600/50">
                                    <div class="aspect-video bg-slate-900 relative overflow-hidden">
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent z-10"></div>
                                        <img src="${m.thumbnailUrl || 'https://source.unsplash.com/random/800x600/?cinema'}" class="w-full h-full object-cover opacity-60 group-hover:opacity-40 transition-opacity"/>
                                        <div class="absolute bottom-3 left-3 z-20">
                                            <span class="text-xs font-bold bg-red-600 text-white px-2 py-0.5 rounded uppercase tracking-wider mb-1 inline-block">${m.genre}</span>
                                            <h3 class="font-bold text-lg leading-tight text-white mt-1">${m.title}</h3>
                                        </div>
                                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity z-30 bg-black/40 backdrop-blur-[1px]">
                                             <div class="bg-red-600 text-white rounded-full p-3 shadow-xl transform scale-75 group-hover:scale-100 transition-transform"><i data-lucide="play" fill="currentColor" class="ml-1"></i></div>
                                        </div>
                                    </div>
                                    <div class="p-4">
                                        <div class="flex justify-between items-center text-xs text-slate-400 mb-3">
                                            <div class="flex items-center gap-1"><i data-lucide="clock" width="12"></i> ${m.duration}</div>
                                            <div class="border border-slate-600 px-1.5 rounded">${m.rating}</div>
                                        </div>
                                        <p class="text-sm text-slate-400 line-clamp-2 leading-relaxed">${m.description}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderAdmin() {
            return `
                <div class="pt-24 pb-12 px-6 max-w-7xl mx-auto min-h-screen animate-fade-in admin-form-container">
                    <div class="max-w-2xl mx-auto">
                        <button onclick="actions.setView('catalog')" class="mb-6 text-sm text-slate-400 hover:text-white flex items-center gap-1">&larr; Voltar</button>
                        
                        <div class="bg-slate-800 rounded-xl p-8 border border-slate-700 shadow-2xl mb-12 relative overflow-hidden">
                            ${(state.form.isGenerating || state.form.isSaving) ? `<div class="absolute top-0 left-0 right-0 h-1 bg-slate-700 progress-bar"><div class="h-full bg-purple-500 w-full"></div></div>` : ''}
                            
                            <div class="flex items-center gap-3 mb-6 border-b border-slate-700 pb-4">
                                <div class="bg-red-600 p-2 rounded-lg"><i data-lucide="wand-2" class="text-white"></i></div>
                                <div>
                                    <h2 class="text-2xl font-bold text-white">${state.editingId ? 'Editar Filme' : 'Novo Filme'}</h2>
                                    <p class="text-slate-400 text-sm">${state.editingId ? 'Atualize os dados abaixo.' : 'IA preenche os detalhes.'}</p>
                                </div>
                            </div>

                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Título</label>
                                    <div class="flex gap-2">
                                        <input class="flex-1 bg-slate-900 border border-slate-700 text-white rounded-lg px-4 py-3 focus:border-red-600 outline-none" placeholder="Ex: Treinamento Vendas" value="${state.form.title}" oninput="actions.updateForm('title', this.value)" />
                                        <button onclick="actions.generateAI()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 rounded-lg font-medium transition-colors flex items-center gap-2 whitespace-nowrap">
                                            ${state.form.isGenerating ? '<span class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></span>' : '<i data-lucide="wand-2" width="18"></i> IA'}
                                        </button>
                                    </div>
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-slate-300 mb-2">Gênero</label><input class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg px-4 py-2 focus:border-red-600 outline-none" value="${state.form.genre}" oninput="actions.updateForm('genre', this.value)" /></div>
                                    <div><label class="block text-sm font-medium text-slate-300 mb-2">Classificação</label><input class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg px-4 py-2 focus:border-red-600 outline-none" value="${state.form.rating}" oninput="actions.updateForm('rating', this.value)" /></div>
                                </div>

                                <div><label class="block text-sm font-medium text-slate-300 mb-2">Duração</label><input class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg px-4 py-2 focus:border-red-600 outline-none" value="${state.form.duration}" oninput="actions.updateForm('duration', this.value)" /></div>
                                
                                <div><label class="block text-sm font-medium text-slate-300 mb-2">Sinopse</label><textarea class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg px-4 py-2 focus:border-red-600 outline-none h-24 resize-none" oninput="actions.updateForm('desc', this.value)">${state.form.desc}</textarea></div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Capa (URL ou IA)</label>
                                    <div class="flex gap-4 items-start">
                                        <div class="flex-1"><input class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg px-4 py-2 focus:border-red-600 outline-none text-xs text-blue-300" value="${state.form.thumbnailUrl}" oninput="actions.updateForm('thumbnailUrl', this.value)" placeholder="URL da imagem..." /></div>
                                        ${state.form.thumbnailUrl ? `<div class="w-24 h-14 bg-slate-700 rounded overflow-hidden border border-slate-600 flex-shrink-0"><img src="${state.form.thumbnailUrl}" class="w-full h-full object-cover" /></div>` : ''}
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Link Drive (Vídeo)</label>
                                    <input class="w-full bg-slate-900 border border-slate-700 text-white rounded-lg px-4 py-3 focus:border-red-600 outline-none font-mono text-sm text-blue-400" placeholder="https://drive.google.com/file/d/..." value="${state.form.url}" oninput="actions.updateForm('url', this.value)" />
                                </div>

                                <div class="pt-4 border-t border-slate-700 flex justify-end gap-3">
                                    ${state.editingId ? `<button onclick="actions.cancelEdit()" class="text-slate-400 hover:text-white px-4 py-3 rounded-lg font-medium transition-colors">Cancelar</button>` : ''}
                                    
                                    <button onclick="actions.saveMovie()" ${state.form.isSaving ? 'disabled' : ''} class="bg-red-600 hover:bg-red-700 text-white px-8 py-3 rounded-lg font-bold transition-all shadow-lg flex items-center gap-2">
                                        ${state.form.isSaving ? 'Salvando...' : (state.editingId ? 'Atualizar Filme' : 'Salvar Filme')}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <h3 class="text-xl font-bold mb-4 text-slate-400">Gerenciar Filmes</h3>
                        <div class="bg-slate-800 rounded-lg border border-slate-700 divide-y divide-slate-700">
                            ${state.movies.map(m => `
                                <div class="p-4 flex justify-between items-center hover:bg-slate-700/50 relative overflow-hidden">
                                    ${state.generatingImages[m.id] ? `<div class="absolute bottom-0 left-0 right-0 h-1 bg-purple-900/50 progress-bar"><div class="h-full bg-purple-500 w-full"></div></div>` : ''}
                                    
                                    <div class="flex gap-4 items-center">
                                        ${m.thumbnailUrl ? `<img src="${m.thumbnailUrl}" class="w-16 h-10 object-cover rounded border border-slate-600" />` : `<div class="w-16 h-10 bg-slate-700 rounded flex items-center justify-center"><i data-lucide="film" width="16"></i></div>`}
                                        <div>
                                            <span class="font-bold block text-white">${m.title}</span>
                                            <span class="text-xs text-slate-500">${m.genre}</span>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <button onclick="actions.editMovie('${m.id}')" class="text-yellow-400 hover:text-yellow-300 hover:bg-yellow-900/20 p-2 rounded transition-colors" title="Editar Filme">
                                            <i data-lucide="pencil" width="18"></i>
                                        </button>
                                        
                                        <button onclick="actions.regenerateImage('${m.id}')" class="text-purple-400 hover:text-purple-300 hover:bg-purple-900/20 p-2 rounded transition-colors" title="Regenerar Capa IA" ${state.generatingImages[m.id] ? 'disabled' : ''}>
                                            ${state.generatingImages[m.id] ? '<span class="animate-spin block w-4 h-4 border-2 border-purple-500 border-t-transparent rounded-full"></span>' : '<i data-lucide="image-plus" width="18"></i>'}
                                        </button>
                                        <button onclick="actions.deleteMovie('${m.id}')" class="text-red-500 hover:text-red-400 hover:bg-red-900/20 p-2 rounded transition-colors" title="Excluir">
                                            <i data-lucide="trash-2" width="18"></i>
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPlayer() {
            const m = state.selectedMovie;
            if (!m) return renderCatalog();
            return `
                <div class="pt-24 pb-12 px-6 max-w-7xl mx-auto animate-fade-in">
                    <button onclick="actions.setView('catalog')" class="mb-6 text-sm text-slate-400 hover:text-white flex items-center gap-1">&larr; Voltar</button>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">
                            <div class="aspect-video bg-black rounded-xl overflow-hidden shadow-2xl relative group border border-slate-800">
                                <iframe src="${m.embedUrl}" class="w-full h-full" frameBorder="0" allow="autoplay; fullscreen" allowFullScreen></iframe>
                            </div>
                            <div>
                                <h1 class="text-4xl font-bold mb-2 text-white">${m.title}</h1>
                                <div class="flex flex-wrap gap-3 text-sm mb-6">
                                    <span class="text-green-400 font-bold">${m.rating}</span>
                                    <span class="text-slate-400">${m.duration}</span>
                                    <span class="text-slate-400">${m.genre}</span>
                                </div>
                                <div class="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                                    <h3 class="text-lg font-bold mb-2 flex items-center gap-2 text-white"><i data-lucide="info" width="18" class="text-red-500"></i> Sobre</h3>
                                    <p class="text-slate-300 leading-relaxed">${m.description}</p>
                                </div>
                            </div>
                        </div>
                        <div class="lg:col-span-1">
                            <h3 class="font-bold text-slate-400 mb-4 uppercase text-xs tracking-wider">Recomendados</h3>
                            <div class="space-y-4">
                                ${state.movies.filter(mv => mv.id !== m.id).slice(0, 4).map(rm => `
                                    <div onclick="actions.openPlayer('${rm.id}')" class="flex gap-3 cursor-pointer group hover:bg-slate-800 p-2 rounded-lg transition-colors">
                                        <div class="w-24 h-14 bg-slate-700 rounded overflow-hidden flex-shrink-0 relative">
                                            <img src="${rm.thumbnailUrl || 'https://source.unsplash.com/random/800x600/?cinema'}" class="w-full h-full object-cover opacity-60" />
                                        </div>
                                        <div>
                                            <h4 class="font-bold text-sm text-slate-200 group-hover:text-red-500 transition-colors line-clamp-1">${rm.title}</h4>
                                            <p class="text-xs text-slate-500 mt-1 line-clamp-2">${rm.description}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderApp() {
            const app = document.getElementById('app');
            let html = renderNavbar();
            html += renderAuthModal();
            html += renderConfirmModal();
            html += renderToast();
            
            if (state.view === 'catalog') html += renderCatalog();
            else if (state.view === 'admin' && state.isAdmin) html += renderAdmin();
            else if (state.view === 'player') html += renderPlayer();
            else html += renderCatalog();

            app.innerHTML = html;
            if (window.lucide) window.lucide.createIcons();
        }

        initFirebase();
    </script>
</body>
</html>
